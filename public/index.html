<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ¿åèŠå¤©å®¤</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 0 10px; display: flex; gap: 20px; }
        #main { flex: 3; }
        #sidebar { flex: 1; border-left: 1px solid #ddd; padding-left: 20px; }
        #chat { height: 450px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; background: #f9f9f9; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; max-width: 80%; padding: 8px 12px; border-radius: 15px; position: relative; }
        .system { align-self: center; color: #888; font-style: italic; font-size: 0.9em; background: none; }
        .other { align-self: flex-start; background: #fff; border: 1px solid #ddd; }
        .me { align-self: flex-end; background: #dcf8c6; text-align: right; }
        .user-name { font-size: 0.7em; color: #666; margin-bottom: 2px; }
        form { display: flex; margin-bottom: 8px; }
        input { flex: 1; padding: 10px; }
        button { padding: 10px; }
        #toolbar { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        #nickname { max-width: 200px; }
        #room-key { max-width: 220px; }
        #emoji-panel { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .emoji-btn { border: 1px solid #ddd; border-radius: 8px; background: #fff; padding: 6px 8px; cursor: pointer; }
        .emoji-btn:hover { background: #f0f0f0; }
        #user-list { font-size: 0.9em; line-height: 1.6; }
        .hint { color: #666; font-size: 0.82em; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div id="main">
        <h2>æ¥µç°¡åŒ¿åèŠå¤©</h2>
        <div id="toolbar">
            <input type="text" id="nickname" maxlength="20" placeholder="ä¿®æ”¹æš±ç¨±" />
            <button type="button" id="rename-btn">æ›´æ–°æš±ç¨±</button>
        </div>
        <div id="toolbar">
            <input type="password" id="room-key" placeholder="å¯é¸ï¼šè¼¸å…¥å¯†èªå•Ÿç”¨ç°¡æ˜“åŠ å¯†" autocomplete="off" />
        </div>
        <div class="hint">è¼¸å…¥ç›¸åŒå¯†èªçš„ä½¿ç”¨è€…å¯è§£è®€è¨Šæ¯ï¼›æœªè¼¸å…¥è€…åªæœƒçœ‹åˆ°äº‚ç¢¼ã€‚</div>
        <div id="chat"></div>
        <form id="form">
            <input type="text" id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off" />
            <button>é€å‡º</button>
        </form>
        <div id="emoji-panel"></div>
    </div>
    <div id="sidebar">
        <h4>åœ¨ç·šåå–®</h4>
        <div id="user-list">è¼‰å…¥ä¸­...</div>
    </div>

    <script>
        // åˆå§‹åŒ–ä½¿ç”¨è€… ID èˆ‡æš±ç¨±
        let userId = localStorage.getItem('chat_userId') || 'u_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chat_userId', userId);

        let myNickname = localStorage.getItem('chat_nickname');
        if (!myNickname) {
            myNickname = prompt("è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±:", "åŒ¿åè€…" + Math.floor(Math.random() * 100)) || "åŒ¿åè€…";
            localStorage.setItem('chat_nickname', myNickname);
        }

        const emojis = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥³', 'ğŸ‘', 'ğŸ™', 'â¤ï¸', 'ğŸ”¥', 'ğŸ˜­', 'ğŸ˜'];
        const chatDiv = document.getElementById('chat');
        const userListDiv = document.getElementById('user-list');
        const nicknameInput = document.getElementById('nickname');
        const msgInput = document.getElementById('msg');
        const roomKeyInput = document.getElementById('room-key');
        const emojiPanel = document.getElementById('emoji-panel');
        nicknameInput.value = myNickname;

        function xorCrypt(text, key) {
            let out = '';
            for (let i = 0; i < text.length; i += 1) {
                out += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return out;
        }

        function encodeMessage(text, key) {
            if (!key) return { text, encrypted: false };
            const encrypted = xorCrypt(unescape(encodeURIComponent(text)), key);
            return { text: btoa(encrypted), encrypted: true };
        }

        function decodeMessage(text, key) {
            if (!key) return '[åŠ å¯†è¨Šæ¯ï¼šè«‹è¼¸å…¥å¯†èªè§£å¯†]';
            try {
                const raw = atob(text);
                const decrypted = xorCrypt(raw, key);
                return decodeURIComponent(escape(decrypted));
            } catch {
                return '[ç„¡æ³•è§£å¯†è¨Šæ¯]';
            }
        }

        function renderMessage(data) {
            const el = document.createElement('div');
            if (data.type === 'system') {
                el.className = 'msg system';
                el.innerText = data.text;
            } else {
                const isMe = data.userId === userId;
                el.className = `msg ${isMe ? 'me' : 'other'}`;

                const nameEl = document.createElement('div');
                nameEl.className = 'user-name';
                nameEl.innerText = data.user;

                const contentEl = document.createElement('div');
                contentEl.innerText = data.encrypted ? decodeMessage(data.text, roomKeyInput.value) : data.text;

                el.appendChild(nameEl);
                el.appendChild(contentEl);
            }

            chatDiv.appendChild(el);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function sendHeartbeat() {
            fetch('/heartbeat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId })
            });
        }

        let lastHeartbeatAt = 0;
        function heartbeatOnActivity() {
            const now = Date.now();
            if (now - lastHeartbeatAt < 20000) return;
            lastHeartbeatAt = now;
            sendHeartbeat();
        }

        emojis.forEach(emoji => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'emoji-btn';
            btn.textContent = emoji;
            btn.onclick = () => {
                msgInput.value += emoji;
                msgInput.focus();
                heartbeatOnActivity();
            };
            emojiPanel.appendChild(btn);
        });

        const evtSource = new EventSource(`/events?id=${userId}&name=${encodeURIComponent(myNickname)}`);

        evtSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'userList') {
                userListDiv.innerHTML = data.users.map(u => `<div>â— ${u}</div>`).join('');
                return;
            }

            renderMessage(data);
        };

        evtSource.onerror = () => {
            renderMessage({ type: 'system', text: 'é€£ç·šå·²ä¸­æ–·ã€‚' });
            evtSource.close();
        };

        document.getElementById('rename-btn').onclick = function() {
            const newName = nicknameInput.value.trim().slice(0, 20);
            if (!newName || newName === myNickname) return;

            fetch('/nickname', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nickname: newName, userId: userId })
            }).then(() => {
                myNickname = newName;
                localStorage.setItem('chat_nickname', myNickname);
            });
        };

        nicknameInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('rename-btn').click();
            }
        });

        document.getElementById('form').onsubmit = function(e) {
            e.preventDefault();
            if (!msgInput.value) return;

            const key = roomKeyInput.value;
            const payload = encodeMessage(msgInput.value, key);

            fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: payload.text, encrypted: payload.encrypted, userId: userId })
            });
            msgInput.value = '';
            heartbeatOnActivity();
        };

        ['mousemove', 'keydown', 'click', 'touchstart'].forEach(eventName => {
            document.addEventListener(eventName, heartbeatOnActivity, { passive: true });
        });
        setInterval(sendHeartbeat, 60000);
        sendHeartbeat();
    </script>
</body>
</html>
```
